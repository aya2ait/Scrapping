name: E-commerce ML Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_scraper:
        description: 'Skip data extraction step'
        required: false
        default: 'false'
        type: boolean
      skip_storage:
        description: 'Skip MongoDB storage step'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.9'
  DOCKERHUB_USERNAME: safaehm

jobs:
  ml-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      MONGODB_VERSION: '5.0'

    services:
      mongodb:
        image: mongo:5.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: ğŸ”§ Install Python dependencies for testing
        run: |
          python -m pip install --upgrade pip
          pip install pymongo requests

      - name: ğŸ—‚ï¸ Setup project directories
        run: |
          mkdir -p data mlruns logs
          ls -la

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ› ï¸ Build and push Docker images
        run: |
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/ecommerce-scraper:latest -f Dockerfile.pipelinee .
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/ecommerce-storage:latest -f Dockerfile.mongo .
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/ecommerce-api:latest -f Dockerfile.api .
          docker push ${{ env.DOCKERHUB_USERNAME }}/ecommerce-scraper:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/ecommerce-storage:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/ecommerce-api:latest

      - name: ğŸ”— Verify MongoDB connection
        run: |
          timeout 30 bash -c 'until nc -z localhost 27017; do sleep 1; done'
          python -c "
          from pymongo import MongoClient
          client = MongoClient('mongodb://localhost:27017/')
          client.admin.command('ping')
          print('âœ… MongoDB is up!')
          "

      - name: ğŸš€ Run Pipeline with Docker Compose
        env:
          SKIP_SCRAPER: ${{ github.event.inputs.skip_scraper || 'false' }}
          SKIP_STORAGE: ${{ github.event.inputs.skip_storage || 'false' }}
        run: |
          # Create docker-compose-ci.yml
          cat > docker-compose-ci.yml << EOF
          services:
            mongodb:
              image: mongo:${{ env.MONGODB_VERSION }}
              volumes:
                - mongodb_data:/data/db
              healthcheck:
                test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
                interval: 10s
                timeout: 5s
                retries: 5
              networks:
                - ml-pipeline-network
            scraper:
              image: ${{ env.DOCKERHUB_USERNAME }}/ecommerce-scraper:latest
              volumes:
                - ./data:/data
                - ./logs:/app/logs
              environment:
                - MONGO_URI=mongodb://mongodb:27017/
              command: ["sh", "-c", "python3 pipeline.py && touch /data/scraper_done && ls -l /data && tail -f /app/logs/unified_extraction_pipeline.log"]
              healthcheck:
                test: ["CMD", "test", "-f", "/data/scraper_done"]
                interval: 10s
                timeout: 5s
                retries: 180
              networks:
                - ml-pipeline-network
            storage:
              image: ${{ env.DOCKERHUB_USERNAME }}/ecommerce-storage:latest
              depends_on:
                mongodb:
                  condition: service_healthy
                scraper:
                  condition: service_healthy
              volumes:
                - ./data:/data
                - ./logs:/app/logs
              environment:
                - MONGO_URI=mongodb://mongodb:27017/
              command: ["sh", "-c", "ls -l /data && python mongo.py /data/unified_extracted_products.csv >> /app/logs/storage.log 2>&1 && touch /data/storage_done || echo 'mongo.py failed' >> /app/logs/storage.log"]
              healthcheck:
                test: ["CMD", "test", "-f", "/data/storage_done"]
                interval: 10s
                timeout: 5s
                retries: 60
              networks:
                - ml-pipeline-network
            api:
              image: ${{ env.DOCKERHUB_USERNAME }}/ecommerce-api:latest
              depends_on:
                storage:
                  condition: service_healthy
              ports:
                - "5000:5000"
              volumes:
                - ./data:/data
                - ./mlruns:/app/mlruns
              environment:
                - MONGO_URI=mongodb://mongodb:27017/
              networks:
                - ml-pipeline-network
          networks:
            ml-pipeline-network:
              driver: bridge
          volumes:
            mongodb_data:
          EOF
          # Run services conditionally
          if [ "$SKIP_SCRAPER" = "true" ]; then
            sed -i "/scraper:/,/^\s*networks:/d" docker-compose-ci.yml
          fi
          if [ "$SKIP_STORAGE" = "true" ]; then
            sed -i "/storage:/,/^\s*networks:/d" docker-compose-ci.yml
          fi
          cat docker-compose-ci.yml
          docker-compose -f docker-compose-ci.yml up -d
          sleep 900
          docker-compose -f docker-compose-ci.yml logs -t
          docker-compose -f docker-compose-ci.yml down

      - name: ğŸ•µï¸ Debug MongoDB Contents
        run: |
          python -c "
          from pymongo import MongoClient
          client = MongoClient('mongodb://localhost:27017/')
          db = client['products_db']
          count = db['products'].count_documents({})
          print(f'Products count: {count}')
          if count > 0:
              sample = db['products'].find_one()
              print(f'Sample document: {sample}')
          else:
              print('No products found')
              exit(1)
          "

      - name: ğŸ“Š Validate pipeline outputs
        run: |
          if [ -f data/unified_extracted_products.csv ]; then
            echo "âœ… Data CSV found:"
            wc -l data/unified_extracted_products.csv
            head -n 5 data/unified_extracted_products.csv
            lines=$(wc -l < data/unified_extracted_products.csv)
            if [ "$lines" -ge 38500 ] && [ "$lines" -le 38510 ]; then
              echo "âœ… Expected ~38503 products"
            else
              echo "âŒ Unexpected CSV size: $lines"
              exit 1
            fi
          else
            echo "âŒ No CSV file found"
            exit 1
          fi

      - name: ğŸ§ª Test MongoDB data storage
        if: ${{ github.event.inputs.skip_storage != 'true' }}
        run: |
          python -c "
          from pymongo import MongoClient
          client = MongoClient('mongodb://localhost:27017/')
          count = client['products_db']['products'].count_documents({})
          print(f'âœ… Products in DB: {count}')
          if count < 38500 or count > 38510:
              print(f'âŒ Expected ~38503 products in MongoDB, got {count}')
              exit(1)
          "

      - name: ğŸ§ª Test API endpoints
        run: |
          curl -f http://localhost:5000/health || { echo "âŒ API health check failed"; exit 1; }
          curl -f http://localhost:5000/api/database-stats || { echo "âŒ API database-stats failed"; exit 1; }
          curl -f -X POST http://localhost:5000/api/top-k-products -H "Content-Type: application/json" -d '{"k": 5, "criteria": "price"}' || { echo "âŒ API top-k-products failed"; exit 1; }

      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-and-data
          path: |
            data/
            logs/